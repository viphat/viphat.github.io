
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Xử lý Background Job trong Ruby bằng Sidekiq</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../assets/css/screen.css?v=c8a6bd0a57">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/styles/monokai_sublime.min.css">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic,500,500italic,700,700italic&amp;subset=latin,latin-ext,vietnamese">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/jqcloud/1.0.4/jqcloud.css">

    <link rel="canonical" href="http://localhost:2368/sidekiq/">
    <meta name="referrer" content="origin">
    
    <meta property="og:site_name" content="viphat's notes">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Xử lý Background Job trong Ruby bằng Sidekiq">
    <meta property="og:description" content="Sidekiq là một trong những Background Processing Libraries được nhiều người sử dụng nhất trong Ruby. So với các lão làng như Delayed Job, Resque hay Active Job vốn có sẵn kể từ Rails 4.2 thì Sidekiq được nhiều...">
    <meta property="og:url" content="http://localhost:2368/sidekiq/">
    <meta property="article:published_time" content="2015-10-28T08:28:50.831Z">
    <meta property="article:modified_time" content="2015-10-28T13:37:51.286Z">
    <meta property="article:tag" content="Ruby on Rails">
    <meta property="article:tag" content="Sidekiq">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Xử lý Background Job trong Ruby bằng Sidekiq">
    <meta name="twitter:description" content="Sidekiq là một trong những Background Processing Libraries được nhiều người sử dụng nhất trong Ruby. So với các lão làng như Delayed Job, Resque hay Active Job vốn có sẵn kể từ Rails 4.2 thì Sidekiq được nhiều...">
    <meta name="twitter:url" content="http://localhost:2368/sidekiq/">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "viphat's notes",
    "author": {
        "@type": "Person",
        "name": "Duong Vi Phat",
        "image": "http://localhost:2368/content/images/2015/09/avatar-ninja.png",
        "url": "http://localhost:2368/author/viphat",
        "sameAs": null,
        "description": null
    },
    "headline": "Xử lý Background Job trong Ruby bằng Sidekiq",
    "url": "http://localhost:2368/sidekiq/",
    "datePublished": "2015-10-28T08:28:50.831Z",
    "dateModified": "2015-10-28T13:37:51.286Z",
    "keywords": "Ruby on Rails, Sidekiq",
    "description": "Sidekiq là một trong những Background Processing Libraries được nhiều người sử dụng nhất trong Ruby. So với các lão làng như Delayed Job, Resque hay Active Job vốn có sẵn kể từ Rails 4.2 thì Sidekiq được nhiều..."
}
    </script>

    <meta name="generator" content="Ghost 0.7">
    <link rel="alternate" type="application/rss+xml" title="viphat's notes" href="http://localhost:2368/rss/">

</head>
<body class="post-template tag-ruby-on-rails tag-sidekiq">

    

<main class="content" role="main">
    <div id="toc"></div>
    <nav class="main-nav">
          <i class="fa fa-bars js-main-menu-open element-light right" style="font-size:30px; margin-left:5px;"></i>
    </nav>
    <article class="post tag-ruby-on-rails tag-sidekiq">



        <header class="post-header">
            <a id="blog-logo" href="http://localhost:2368">
                    <img src="../content/images/2015/06/988902_10153164942799169_3258802522813421684_n.jpg" alt="notes.viphat.work">
            </a>
        </header>


        <span class="post-meta"><time datetime="2015-10-28">28 Oct 2015</time> on <a href="../tag/ruby-on-rails/">Ruby on Rails</a> | <a href="../tag/sidekiq/">Sidekiq</a></span>

        <h1 class="post-title">Xử lý Background Job trong Ruby bằng Sidekiq</h1>

        <section class="post-content">
            <p><a href="https://github.com/mperham/sidekiq"><strong>Sidekiq</strong></a> là một trong những Background Processing Libraries được nhiều người sử dụng nhất trong Ruby. So với các lão làng như <a href="https://github.com/collectiveidea/delayed_job">Delayed Job</a>, <a href="https://github.com/resque/resque">Resque</a> hay <a href="http://edgeguides.rubyonrails.org/active_job_basics.html">Active Job</a> vốn có sẵn kể từ Rails 4.2 thì Sidekiq được nhiều người tin dùng bởi tính lightweight (Do sử dụng Redis thay vì ActiveRecord và Performance, Memory Efficient cũng tốt hơn Resque). Tuy vậy, Sidekiq cũng khó sử dụng hơn so với Delayed Job và Active Job nên nếu bạn chưa quen với Sidekiq, bạn có thể sẽ mau nản.</p>

<p>Trước đây, khi nhận dự án UBrand về thì Team Develop trước đã dùng Delayed Job, nhưng sau khi go live thì mình thấy Delayed Job khá chậm, lại tốn nhiều resource của hệ thống nên đã tìm giải pháp khác thay thế, và do đó đã tìm đến Sidekiq.</p>

<p>Sidekiq có 3 phiên bản là Sidekiq OSS, Sidekiq Pro, Sidekiq Enterprise, bạn có thể tham khảo chi tiết tại trang chủ của Sidekiq tại <a href="http://sidekiq.org">http://sidekiq.org</a>. Riêng với cá nhân mình thì thấy rằng phiên bản OpenSource của Sidekiq là khá đủ dùng, nếu cần thêm các chức năng Advanced mà Sidekiq OSS không có thì hoàn toàn có thể cài thêm một số gem khác phụ trợ (Ví dụ dùng Sidetiq cho Recurring Job).</p>

<p>Bài viết này nhằm ghi lại một số kinh nghiệm khi dùng Sidekiq cho dự án.</p>

<hr>

<h4 id="sidekiqwebui">Sidekiq Web UI</h4>

<p>Theo dõi và quản trị các Jobs/Worker trên Sidekiq bằng giao diện Web.</p>

<p>Link: <a href="https://github.com/mperham/sidekiq/wiki/Monitoring">https://github.com/mperham/sidekiq/wiki/Monitoring</a></p>

<p>Cài đặt Sidekiq Web UI cho dự án Rails:</p>

<ul>
<li>Thêm gem sinatra vào dự án của bạn:</li>
</ul>

<pre><code>gem 'sinatra', :require =&gt; nil  
</code></pre>

<ul>
<li>Thêm vào routes.rb (Nếu Authenticate bằng Devise - Chỉ có quyền Admin mới được phép truy cập vào đường dẫn /sidekiq):</li>
</ul>

<pre><code>require 'sidekiq/web'  
authenticate :user, lambda { |u| u.admin? } do  
  mount Sidekiq::Web =&gt; '/sidekiq'
end
</code></pre>

<hr>

<h4 id="mtsgemhuchbsungchosidekiq">Một số Gem hữu ích để bổ sung cho Sidekiq</h4>

<h5 id="sidekiqthrottler">Sidekiq Throttler</h5>

<p>Sidekiq-throttler, một middleware cho sidekiq để thêm chức năng giới hạn số lượng job thực thi trên mỗi worker tại một thời điểm.</p>

<p>Link: <a href="https://github.com/gevans/sidekiq-throttler">https://github.com/gevans/sidekiq-throttler</a> (đã lâu không cập nhật nhưng mình vẫn dùng tốt ở thSidetiqời điểm hiện tại - (Ruby 2.2, Rails 4.2 và Sidekiq 3.4)</p>

<h5 id="sidekiqfailures">Sidekiq Failures</h5>

<ul>
<li>Bổ sung Tab Failures vào Sidekiq Web UI để bạn có thể track các failed job trực tiếp ngay trên giao diện.</li>
</ul>

<p>Link: <a href="https://github.com/mhfs/sidekiq-failures">https://github.com/mhfs/sidekiq-failures</a></p>

<h5 id="sidekiqstatistic">Sidekiq Statistic</h5>

<ul>
<li>Bổ sung tab Statistic vào Sidekiq Web UI để coi các thống kê của các Worker theo thời gian thực.</li>
</ul>

<p>Link: <a href="https://github.com/davydovanton/sidekiq-statistic">https://github.com/davydovanton/sidekiq-statistic</a></p>

<p><img src="http://i.imgur.com/gTWmeeX.png" alt="Sidekiq Statistic"></p>

<h5 id="sidetiq">Sidetiq</h5>

<p>Nếu bạn có một hay vài Job cần chạy recurring thì không thể bỏ qua Sidetiq</p>

<p>Link: <a href="https://github.com/tobiassvn/sidetiq">https://github.com/tobiassvn/sidetiq</a></p>

<hr>

<h5 id="mtslnhsidekiqtgpnhngilcscnn">Một số lệnh Sidekiq ít gặp nhưng đôi lúc sẽ cần đến</h5>

<ul>
<li><strong>Clear các Jobs trong Sidekiq Queue / RetrySet / ScheduledSet</strong>: Cái này mình đã dùng trong tình huống Project của mình có một  Bug khiến một loạt các Jobs "AutoLike" bị lỗi, mà Sidekiq gặp một Job bị failed sẽ cố gắng thử chạy lại Job đó nhiều lần. Để tiết kiệm tài nguyên hệ thống, mình đã buộc phải xóa hết các Jobs đang còn trong Queue, cũng như trong RetrySet và ScheduledSet (vì mình đã thiết lập chỉ cho phép chạy tối đa 25 jobs / phút nên các job còn lại sẽ được Sidekiq đưa vào Scheduled.)</li>
</ul>

<pre><code class="language-ruby">require 'sidekiq/api'  
Sidekiq::Queue.new("infinity").clear  
Sidekiq::RetrySet.new.clear  
Sidekiq::ScheduledSet.new.clear  
</code></pre>

<ul>
<li><strong>Reset Sidekiq Counter</strong>: đôi lúc thấy con số job failed ngứa mắt quá nên reset nó về 0. (Bạn cũng có thể làm được việc này ngay trong Web UI bằng gem <strong>Sidekiq Failures</strong>)</li>
</ul>

<pre><code class="language-ruby">Sidekiq.redis {|c| c.del('stat:failed') }  
</code></pre>

<ul>
<li>Clear Counter theo ngày cụ thể:</li>
</ul>

<pre><code>Sidekiq.redis {|c| c.del('stat:processed:2015-07-02') }  
Sidekiq.redis {|c| c.del('stat:failed:2015-07-02') }  
</code></pre>
        </section>

        <footer class="post-footer">

                <section class="author">
                    <h3>Duong Vi Phat</h3>
                    <p></p>
                </section>

            <section class="share">
                <h3>Share this</h3>
                <a class="icon-twitter" href="http://twitter.com/share?text=X%E1%BB%AD%20l%C3%BD%20Background%20Job%20trong%20Ruby%20b%E1%BA%B1ng%20Sidekiq&amp;url=http://localhost:2368/sidekiq/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/sidekiq/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://localhost:2368/sidekiq/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

        </footer>


    </article>

</main>


    <footer class="site-footer">
        <!-- <a class="subscribe icon-feed" href="http://localhost:2368/rss/"><span class="tooltip">Subscribe!</span></a> -->
        <div class="inner">
             <section class="social_links">
                <a href="https://twitter.com/viphat" target="_blank">
                  <i class="fa fa-twitter-square fa-2x"></i>
                </a>
                <a href="https://www.facebook.com/viphat" target="_blank">
                  <i class="fa fa-facebook-square fa-2x"></i>
                </a>
                <a href="https://github.com/viphat" target="_blank">
                  <i class="fa fa-github-square fa-2x"></i>
                </a>
             </section>
             <section class="copyright">All content copyright <a href="../">viphat's notes</a> © 2014-2015 • All rights reserved.</section>
             <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://ghost.org">Ghost</a> in <a href="https://github.com/viphat/The-Shell">The Shell</a> theme.</section>
        </div>
    </footer>

        <div class="main-menu-ovrl main-menu-ovrl-hugeinc js-main-menu-ovrl">
    <i class="fa fa-times main-menu-ovrl-close js-main-menu-close" style="margin-left: 5px; font-size:30px;"></i>
    <nav>
        <ul>
                <li style="font-size: 42px; padding-bottom:10px;">
                    <a href="http://localhost:2368/">Home</a>
                </li>
                <li style="font-size: 42px; padding-bottom:10px;">
                    <a href="http://localhost:2368/tag-cloud/">Tag Cloud</a>
                </li>
                <li style="font-size: 42px; padding-bottom:10px;">
                    <a href="http://localhost:2368/blog-archive/">Blog Archive</a>
                </li>
        </ul>
    </nav>
</div>

    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-53685619-1', 'auto');
      ga('send', 'pageview');
    </script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/highlight.min.js"></script>
    <script type="text/javascript" src="../assets/js/jqcloud-1.0.4.js"></script>
    <script type="text/javascript" src="../assets/js/toc.min.js"></script>
    <script type="text/javascript" src="../assets/js/shell.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.3/handlebars.min.js"></script>
</body>
