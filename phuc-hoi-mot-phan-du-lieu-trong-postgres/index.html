
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Phục hồi một phần dữ liệu trong Postgres</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../assets/css/screen.css?v=da5b0d61e5">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/styles/monokai_sublime.min.css">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic,500,500italic,700,700italic&amp;subset=latin,latin-ext,vietnamese">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/jqcloud/1.0.4/jqcloud.css">

    <link rel="canonical" href="http://localhost:2368/phuc-hoi-mot-phan-du-lieu-trong-postgres/">
    <meta name="referrer" content="origin">
    
    <meta property="og:site_name" content="viphat's notes">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Phục hồi một phần dữ liệu trong Postgres">
    <meta property="og:description" content="Đây là bài học xương máu rút ra được khi can thiệp database trực tiếp trên Production vì làm mất data của một Table (may là phát hiện kịp nên đã break câu lệnh destroy data). Sau khi rà soát...">
    <meta property="og:url" content="http://localhost:2368/phuc-hoi-mot-phan-du-lieu-trong-postgres/">
    <meta property="article:published_time" content="2015-09-20T02:46:40.176Z">
    <meta property="article:modified_time" content="2015-09-20T02:46:40.175Z">
    <meta property="article:tag" content="Postgres">
    <meta property="article:tag" content="Today I Learned">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Phục hồi một phần dữ liệu trong Postgres">
    <meta name="twitter:description" content="Đây là bài học xương máu rút ra được khi can thiệp database trực tiếp trên Production vì làm mất data của một Table (may là phát hiện kịp nên đã break câu lệnh destroy data). Sau khi rà soát...">
    <meta name="twitter:url" content="http://localhost:2368/phuc-hoi-mot-phan-du-lieu-trong-postgres/">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "viphat's notes",
    "author": {
        "@type": "Person",
        "name": "Duong Vi Phat",
        "image": "http://localhost:2368/content/images/2015/09/avatar-ninja.png",
        "url": "http://localhost:2368/author/viphat",
        "sameAs": null,
        "description": null
    },
    "headline": "Phục hồi một phần dữ liệu trong Postgres",
    "url": "http://localhost:2368/phuc-hoi-mot-phan-du-lieu-trong-postgres/",
    "datePublished": "2015-09-20T02:46:40.176Z",
    "dateModified": "2015-09-20T02:46:40.175Z",
    "keywords": "Postgres, Today I Learned",
    "description": "Đây là bài học xương máu rút ra được khi can thiệp database trực tiếp trên Production vì làm mất data của một Table (may là phát hiện kịp nên đã break câu lệnh destroy data). Sau khi rà soát..."
}
    </script>

    <meta name="generator" content="Ghost 0.7">
    <link rel="alternate" type="application/rss+xml" title="viphat's notes" href="http://localhost:2368/rss/">

</head>
<body class="post-template tag-postgres tag-today-i-learned">

    

<main class="content" role="main">
    <div id="toc"></div>
    <nav class="main-nav">
          <i class="fa fa-bars js-main-menu-open element-light right" style="font-size:30px; margin-left:5px;"></i>
    </nav>
    <article class="post tag-postgres tag-today-i-learned">



        <header class="post-header">
            <a id="blog-logo" href="http://localhost:2368">
                    <img src="../content/images/2015/06/988902_10153164942799169_3258802522813421684_n.jpg" alt="notes.viphat.work">
            </a>
        </header>


        <span class="post-meta"><time datetime="2015-09-20">20 Sep 2015</time> on <a href="../tag/postgres/">Postgres</a> | <a href="../tag/today-i-learned/">Today I Learned</a></span>

        <h1 class="post-title">Phục hồi một phần dữ liệu trong Postgres</h1>

        <section class="post-content">
            <p>Đây là bài học xương máu rút ra được khi can thiệp database trực tiếp trên Production vì làm mất data của một Table (may là phát hiện kịp nên đã break câu lệnh destroy data). Sau khi rà soát thiệt hại thì mình thống kê là cần phải khôi phục lại khoảng 1000 record đầu tiên của Table đó trên Postgres. Vậy làm thế nào để khôi phục một phần dữ liệu của một table thay vì bung bản backup ra và restore lại toàn bộ database?</p>

<p>Thật may là Postgres có hỗ trợ lệnh COPY data và đây là cách mình đã khôi phục lại 1000 record bị xóa nhầm:</p>

<ul>
<li>Restore lại file dump (có chứa 1000 record đấy) của database hiện tại sang một database khác.</li>
<li>Khoanh vùng thiệt hại (CONDITION X) và sử dụng lệnh COPY của postgres để copy dữ liệu bị mất và lưu vào file.</li>
</ul>

<pre><code>COPY (SELECT * FROM mytable WHERE [_CONDITION X_]...) TO '/tmp/myfile.tsv'  
</code></pre>

<ul>
<li>Restore lại file đó vào database production</li>
</ul>

<pre><code>COPY mytable FROM 'myfile.tsv'  
</code></pre>

<ul>
<li>Trong quá trình này, lưu ý cập nhật lại id_seq của table nếu cần thiết.</li>
</ul>

<pre><code>-- Login to psql and run the following
-- What is the result?
SELECT MAX(id) FROM your_table;

-- Then run...
-- This should be higher than the last result.
SELECT nextval('your_table_id_seq');

-- If it's not higher... run this set the sequence last to your highest pid it. 
-- (wise to run a quick pg_dump first...)
SELECT setval('your_table_id_seq', (SELECT MAX(id) FROM your_table));  
-- if your tables might have no rows
-- false means the set value will be returned by the next nextval() call    
SELECT setval('your_table_id_seq', COALESCE((SELECT MAX(id)+1 FROM your_table), 1), false);  
</code></pre>
        </section>

        <footer class="post-footer">

                <section class="author">
                    <h3>Duong Vi Phat</h3>
                    <p></p>
                </section>

            <section class="share">
                <h3>Share this</h3>
                <a class="icon-twitter" href="http://twitter.com/share?text=Ph%E1%BB%A5c%20h%E1%BB%93i%20m%E1%BB%99t%20ph%E1%BA%A7n%20d%E1%BB%AF%20li%E1%BB%87u%20trong%20Postgres&amp;url=http://localhost:2368/phuc-hoi-mot-phan-du-lieu-trong-postgres/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/phuc-hoi-mot-phan-du-lieu-trong-postgres/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://localhost:2368/phuc-hoi-mot-phan-du-lieu-trong-postgres/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

        </footer>


    </article>

</main>


    <footer class="site-footer">
        <!-- <a class="subscribe icon-feed" href="http://localhost:2368/rss/"><span class="tooltip">Subscribe!</span></a> -->
        <div class="inner">
             <section class="social_links">
                <a href="https://twitter.com/viphat" target="_blank">
                  <i class="fa fa-twitter-square fa-2x"></i>
                </a>
                <a href="https://www.facebook.com/viphat" target="_blank">
                  <i class="fa fa-facebook-square fa-2x"></i>
                </a>
                <a href="https://github.com/viphat" target="_blank">
                  <i class="fa fa-github-square fa-2x"></i>
                </a>
             </section>
             <section class="copyright">All content copyright <a href="../">viphat's notes</a> © 2014-2015 • All rights reserved.</section>
             <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://ghost.org">Ghost</a> in <a href="https://github.com/viphat/The-Shell">The Shell</a> theme.</section>
        </div>
    </footer>

        <div class="main-menu-ovrl main-menu-ovrl-hugeinc js-main-menu-ovrl">
    <i class="fa fa-times main-menu-ovrl-close js-main-menu-close" style="margin-left: 5px; font-size:30px;"></i>
    <nav>
        <ul>
                <li style="font-size: 42px; padding-bottom:10px;">
                    <a href="http://localhost:2368/">Home</a>
                </li>
                <li style="font-size: 42px; padding-bottom:10px;">
                    <a href="http://localhost:2368/tag-cloud/">Tag Cloud</a>
                </li>
                <li style="font-size: 42px; padding-bottom:10px;">
                    <a href="http://localhost:2368/blog-archive/">Blog Archive</a>
                </li>
        </ul>
    </nav>
</div>

    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-53685619-1', 'auto');
      ga('send', 'pageview');
    </script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/highlight.min.js"></script>
    <script type="text/javascript" src="../assets/js/jqcloud-1.0.4.js"></script>
    <script type="text/javascript" src="../assets/js/toc.min.js"></script>
    <script type="text/javascript" src="../assets/js/shell.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.3/handlebars.min.js"></script>
</body>
