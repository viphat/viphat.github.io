
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>[TIL] Paperclip Fingerprint</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../assets/css/screen.css?v=0acad0f45c">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/styles/monokai_sublime.min.css">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic,500,500italic,700,700italic&amp;subset=latin,latin-ext,vietnamese">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/jqcloud/1.0.4/jqcloud.css">

    <link rel="canonical" href="http://localhost:2368/paperclip-fingerprint/">
    <meta name="referrer" content="origin">
    
    <meta property="og:site_name" content="viphat's notes">
    <meta property="og:type" content="article">
    <meta property="og:title" content="[TIL] Paperclip Fingerprint">
    <meta property="og:description" content="Paperclip Fingerprint Tình huống của hôm nay là Sếp bỗng dưng muốn chuyển tất cả assets của ứng dụng từ Amazon S3 về VCCloud CDN (đang khuyến mãi gói 100 GB miễn phí, giá tính ra không đắt hơn Amazon...">
    <meta property="og:url" content="http://localhost:2368/paperclip-fingerprint/">
    <meta property="article:published_time" content="2016-05-12T15:52:26.705Z">
    <meta property="article:modified_time" content="2016-05-12T15:52:26.704Z">
    <meta property="article:tag" content="Ruby on Rails">
    <meta property="article:tag" content="TIL">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="[TIL] Paperclip Fingerprint">
    <meta name="twitter:description" content="Paperclip Fingerprint Tình huống của hôm nay là Sếp bỗng dưng muốn chuyển tất cả assets của ứng dụng từ Amazon S3 về VCCloud CDN (đang khuyến mãi gói 100 GB miễn phí, giá tính ra không đắt hơn Amazon...">
    <meta name="twitter:url" content="http://localhost:2368/paperclip-fingerprint/">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "viphat's notes",
    "author": {
        "@type": "Person",
        "name": "Duong Vi Phat",
        "image": "http://localhost:2368/content/images/2015/09/avatar-ninja.png",
        "url": "http://localhost:2368/author/viphat",
        "sameAs": null,
        "description": null
    },
    "headline": "[TIL] Paperclip Fingerprint",
    "url": "http://localhost:2368/paperclip-fingerprint/",
    "datePublished": "2016-05-12T15:52:26.705Z",
    "dateModified": "2016-05-12T15:52:26.704Z",
    "keywords": "Ruby on Rails, TIL",
    "description": "Paperclip Fingerprint Tình huống của hôm nay là Sếp bỗng dưng muốn chuyển tất cả assets của ứng dụng từ Amazon S3 về VCCloud CDN (đang khuyến mãi gói 100 GB miễn phí, giá tính ra không đắt hơn Amazon..."
}
    </script>

    <meta name="generator" content="Ghost 0.7">
    <link rel="alternate" type="application/rss+xml" title="viphat's notes" href="http://localhost:2368/rss/">

</head>
<body class="post-template tag-ruby-on-rails tag-til">

    

<main class="content" role="main">
    <div id="toc"></div>
    <nav class="main-nav">
          <i class="fa fa-bars js-main-menu-open element-light right" style="font-size:30px; margin-left:5px;"></i>
    </nav>
    <article class="post tag-ruby-on-rails tag-til">



        <header class="post-header">
            <a id="blog-logo" href="http://localhost:2368">
                    <img src="../content/images/2015/06/988902_10153164942799169_3258802522813421684_n.jpg" alt="notes.viphat.work">
            </a>
        </header>


        <span class="post-meta"><time datetime="2016-05-12">12 May 2016</time> on <a href="../tag/ruby-on-rails/">Ruby on Rails</a> | <a href="../tag/til/">TIL</a></span>

        <h1 class="post-title">[TIL] Paperclip Fingerprint</h1>

        <section class="post-content">
            <h3 id="paperclipfingerprint">Paperclip Fingerprint</h3>

<p>Tình huống của hôm nay là Sếp bỗng dưng muốn chuyển tất cả assets của ứng dụng từ <strong>Amazon S3</strong> về <strong>VCCloud CDN</strong> (đang khuyến mãi gói 100 GB miễn phí, giá tính ra không đắt hơn Amazon S3 nhiều lắm và được khoản Servers đặt ở Hà Nội - Đà Nẵng - Hồ Chí Minh nên thích hợp cho App có lượng lớn truy cập từ VN.)</p>

<p>Sử dụng CDN của VCCloud cũng đơn giản, chẳng phải setup nhiều, chỉ add domain của S3 Bucket vào là chạy được ngay (Enable Static Web Hosting cho Bucket S3 để có sub-domain riêng). Nhưng đẻ ra một vấn đề là trước đây, dùng Paperclip để upload users's file lên S3 mà không có fingerprint, giờ mà dùng CDN thì hỏng bét, nếu file ở S3 có thay đổi thì CDN vẫn serve file cũ. &gt;&gt;&gt; Enable Fingerprint vào tên file cho Paperclip</p>

<p>1 . Tạo <em>Migration</em>  cho tất cả các cột có sử dụng Paperclip handle attachment</p>

<pre><code>class AddAvatarFingerPrintToUsers &lt; ActiveRecord::Migration  
  def change
    add_column :users, :avatar_fingerprint, :string
  end
end  
</code></pre>

<p>2 . Thêm Fingerprint vào tên file (đây là ví dụ cho trường hợp của mình)</p>

<p><code>config/initializers/paperclip.rb</code></p>

<pre><code class="language- ">Paperclip::Attachment.default_options.merge! {  
  :path =&gt; ":class/:attachment/:id_:style_:fingerprint.:extension"
}
</code></pre>

<p>Xong bước này thì tất cả file mới upload sau này đều có fingerprint.</p>

<p>3 . Xử lý file đã upload trước đây bằng cách chạy rake sau:</p>

<pre><code>RAILS_ENV=production rake paperclip:refresh CLASS=model_name  
</code></pre>

<p>3b . Nếu không muốn chạy Rake trên thì có thể xử lý thủ công bằng:</p>

<pre><code>users_to_reprocess.each do |user|  
  user.avatar.reprocess!
end
</code></pre>

<p>viphat@13-05-2016</p>
        </section>

        <footer class="post-footer">

                <section class="author">
                    <h3>Duong Vi Phat</h3>
                    <p></p>
                </section>

            <section class="share">
                <h3>Share this</h3>
                <a class="icon-twitter" href="http://twitter.com/share?text=%5BTIL%5D%20Paperclip%20Fingerprint&amp;url=http://localhost:2368/paperclip-fingerprint/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:2368/paperclip-fingerprint/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://localhost:2368/paperclip-fingerprint/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

        </footer>


    </article>

</main>


    <footer class="site-footer">
        <!-- <a class="subscribe icon-feed" href="http://localhost:2368/rss/"><span class="tooltip">Subscribe!</span></a> -->
        <div class="inner">
             <section class="social_links">
                <a href="https://twitter.com/viphat" target="_blank">
                  <i class="fa fa-twitter-square fa-2x"></i>
                </a>
                <a href="https://www.facebook.com/viphat" target="_blank">
                  <i class="fa fa-facebook-square fa-2x"></i>
                </a>
                <a href="https://github.com/viphat" target="_blank">
                  <i class="fa fa-github-square fa-2x"></i>
                </a>
             </section>
             <section class="copyright">All content copyright <a href="../">viphat's notes</a> © 2014-2015 • All rights reserved.</section>
             <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://ghost.org">Ghost</a> in <a href="https://github.com/viphat/The-Shell">The Shell</a> theme.</section>
        </div>
    </footer>

        <div class="main-menu-ovrl main-menu-ovrl-hugeinc js-main-menu-ovrl">
    <i class="fa fa-times main-menu-ovrl-close js-main-menu-close" style="margin-left: 5px; font-size:30px;"></i>
</div>

    <!-- You can safely delete this line if your theme does not require jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-53685619-1', 'auto');
      ga('send', 'pageview');
    </script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/highlight.min.js"></script>
    <script type="text/javascript" src="../assets/js/jqcloud-1.0.4.js"></script>
    <script type="text/javascript" src="../assets/js/toc.min.js"></script>
    <script type="text/javascript" src="../assets/js/shell.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.3/handlebars.min.js"></script>
</body>
